sequenceDiagram
    participant F as 前端 Frontend
    participant W as WebSocket 服务
    participant M as MTS Service
    participant S as Sportradar MTS
    
    Note over F,S: WebSocket 连接生命周期
    
    F->>W: 建立 WebSocket 连接<br/>ws://mts-service/ws?userId=xxx&token=xxx
    W->>W: 验证 token 和用户身份
    alt 验证成功
        W-->>F: 连接成功<br/>type: connection_established
        Note over F,W: 连接已建立，开始心跳
    else 验证失败
        W-->>F: 连接拒绝<br/>type: connection_rejected
        W->>W: 关闭连接
    end
    
    loop 每 30 秒
        F->>W: 发送心跳<br/>type: ping
        W-->>F: 响应心跳<br/>type: pong
    end
    
    Note over F,W: 如果 60 秒内未收到心跳，服务端主动断开连接
    
    alt 网络异常
        W->>W: 检测到连接断开
        W->>W: 清理用户会话
        F->>F: 检测到连接断开
        F->>F: 尝试重连（指数退避）
        F->>W: 重新建立连接
    end
    
    Note over F,W: 用户主动关闭页面或登出
    F->>W: 关闭 WebSocket 连接
    W->>W: 清理用户会话
    W-->>F: 连接关闭确认
