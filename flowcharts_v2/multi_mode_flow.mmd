flowchart TD
    Start([用户切换到串关模式]) --> CheckSelections{投注单中选项数量}
    CheckSelections -->|< 2 个| NotAvailable[显示提示：至少需要2个选项]
    CheckSelections -->|≥ 2 个| ShowTabs[显示子标签页]
    
    ShowTabs --> RenderTabs[渲染标签页<br/>1. 串关Accumulator<br/>2. 系统System选项≥3<br/>3. BankerSystem视图内]
    RenderTabs --> DefaultTab[默认显示串关标签页]
    
    DefaultTab --> UserSelectTab{用户选择标签页}
    
    UserSelectTab -->|串关| AccumulatorFlow[进入串关流程]
    UserSelectTab -->|系统| SystemFlow[进入系统投注流程]
    
    AccumulatorFlow --> CalcTotalOdds[计算总赔率<br/>总赔率 = 所有选项赔率的乘积]
    CalcTotalOdds --> DisplayOdds[显示总赔率]
    DisplayOdds --> InputAmount[用户输入总投注金额]
    InputAmount --> CalcPayout[计算预计总返还<br/>总返还 = 金额 × 总赔率]
    CalcPayout --> DisplayPayout[显示预计总返还]
    DisplayPayout --> ClickBetAccum{用户点击投注}
    
    ClickBetAccum --> DisableBtn1[禁用按钮并显示加载状态]
    DisableBtn1 --> BuildAccumRequest[构建 API 请求<br/>POST /api/bets/accumulator]
    BuildAccumRequest --> SendRequest1[发送请求]
    
    SystemFlow --> CheckBanker{用户标记Banker?}
    CheckBanker -->|否| GenerateCombos[生成所有系统组合<br/>例如：二串一、三串一、Yankee]
    CheckBanker -->|是| MarkBanker[标记Banker选项并高亮]
    
    MarkBanker --> RecalcCombos[重新计算系统组合<br/>基于非Banker选项]
    RecalcCombos --> GenerateCombos
    
    GenerateCombos --> DisplayCombos[显示组合列表]
    DisplayCombos --> InputCombos[用户为组合输入单位金额]
    InputCombos --> CalcCombosTotal[计算总投注额]
    CalcCombosTotal --> DisplayCombosTotal[显示总投注额]
    DisplayCombosTotal --> ClickBetSystem{用户点击投注}
    
    ClickBetSystem --> DisableBtn2[禁用按钮并显示加载状态]
    DisableBtn2 --> CheckBankerAPI{是否有Banker?}
    CheckBankerAPI -->|是| BuildBankerRequest[构建 API 请求<br/>POST /api/bets/banker-system]
    CheckBankerAPI -->|否| BuildSystemRequest[构建 API 请求<br/>POST /api/bets/system 或 preset]
    
    BuildBankerRequest --> SendRequest2[发送请求]
    BuildSystemRequest --> SendRequest2
    
    SendRequest1 --> WaitResponse[等待响应]
    SendRequest2 --> WaitResponse
    
    WaitResponse --> CheckResponse{响应状态}
    CheckResponse -->|200 OK| Success[显示成功提示]
    CheckResponse -->|4xx/5xx| Error[显示错误信息]
    
    Success --> ClearBetSlip[清空投注单]
    ClearBetSlip --> End([结束])
    
    Error --> KeepBetSlip[保留投注单内容]
    KeepBetSlip --> EnableBtn[重新启用投注按钮]
    EnableBtn --> UserSelectTab
    
    NotAvailable --> End
    
    style Start fill:#4CAF50,stroke:#2E7D32,color:#fff
    style End fill:#F44336,stroke:#C62828,color:#fff
    style ShowTabs fill:#9C27B0,stroke:#6A1B9A,color:#fff
    style Success fill:#4CAF50,stroke:#2E7D32,color:#fff
    style Error fill:#FF9800,stroke:#E65100,color:#fff
    style SendRequest1 fill:#9C27B0,stroke:#6A1B9A,color:#fff
    style SendRequest2 fill:#9C27B0,stroke:#6A1B9A,color:#fff
    style CheckResponse fill:#FFC107,stroke:#F57C00,color:#000
    style AccumulatorFlow fill:#2196F3,stroke:#1565C0,color:#fff
    style SystemFlow fill:#3F51B5,stroke:#1A237E,color:#fff
    style MarkBanker fill:#E91E63,stroke:#880E4F,color:#fff
    style RecalcCombos fill:#00BCD4,stroke:#00838F,color:#fff
